name: Lockfile Consistency Check
permissions:
    contents: read

on:
    pull_request:
        branches:
            - main
            - master

jobs:
    lockfile-consistency:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Check for package.json changes without package-lock.json update
              env:
                  BASE: ${{ github.base_ref }}
              run: |
                  set -euo pipefail
                  echo "Comparing changes against origin/$BASE"
                  CHANGED=$(git diff --name-only origin/$BASE..HEAD)
                  echo "$CHANGED"
                  if echo "$CHANGED" | grep -q "^package.json$"; then
                      if echo "$CHANGED" | grep -q "^package-lock.json$"; then
                          echo "package-lock.json updated alongside package.json"
                          exit 0
                      fi
                      echo "package.json changed without package-lock.json; inspecting dependency-related fields..."
                      node <<'NODE'
                      const { execSync } = require('node:child_process');
                      const fs = require('node:fs');
                      const base = process.env.BASE;
                      if (!base) {
                        console.error('BASE ref missing, cannot validate package-lock consistency.');
                        process.exit(1);
                      }
                      const file = 'package.json';
                      const headJson = JSON.parse(fs.readFileSync(file, 'utf8'));
                      const baseJson = JSON.parse(execSync(`git show origin/${base}:${file}`, { encoding: 'utf8' }));
                      const keys = [
                        'dependencies',
                        'devDependencies',
                        'peerDependencies',
                        'optionalDependencies',
                        'overrides',
                        'resolutions',
                        'workspaces',
                        'packageManager',
                        'engines'
                      ];
                      const changedKeys = keys.filter(
                        key => JSON.stringify(headJson[key] ?? {}) !== JSON.stringify(baseJson[key] ?? {})
                      );
                      if (changedKeys.length > 0) {
                        console.error(
                          `Error: package.json fields [${changedKeys.join(', ')}] changed without updating package-lock.json. Run 'npm install' and commit the new lockfile.`
                        );
                        process.exit(1);
                      }
                      console.log('package.json changes only affected metadata/scripts; no lockfile update required.');
                      NODE
                  fi
